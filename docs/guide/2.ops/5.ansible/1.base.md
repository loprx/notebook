---
title: 基础
order: 1
---

# 基础

## 安装

- Ubuntu

```shell
sudo apt update && sudo apt install ansible
```

## 清单（Inventory）

### host

```ini
[kube_master]
master ansible_host=172.29.101.173 ansible_user=root

[kube_node]
node1 ansible_host=172.29.101.174 ansible_user=root
node2 ansible_host=172.29.101.175 ansible_user=root
node3 ansible_host=172.29.101.176 ansible_user=root
```

测试主机连通性

```shell
ansible -m ping all
```

## 剧本（Playbook）

> 一个剧本由一个或多个按顺序排列的“剧目”组成。“剧本”和“剧目”这两个术语是体育类比。每个剧目执行剧本的总体目标的一部分，运行一个或多个任务。每个任务调用一个 Ansible 模块。

```yaml
- hosts: all
  become: yes
  roles:
    - common

- hosts: kube_master
  become: yes
  roles:
    - k8s-master

- hosts: kube_node
  become: yes
  roles:
    - k8s-node
```

## 角色（Role）

> 角色是 Ansible 的核心概念，它定义了任务和变量的集合。

角色由一个或多个文件组成，这些文件定义了角色的元数据、变量、任务、模板、文件、handlers 等。

```shell
│  inventory.ini
│  kubeadm-config.yaml
│  playbook.yml
│  
└─roles
    ├─common
    |  └─meta/main.yml
    │  └─tasks/main.yml
    |
    ├─k8s-master
    │  └─tasks/main.yml
    |
    └─k8s-node
        └─tasks/main.yml
```

### 角色元数据文件 `common/meta/main.yml`

> 描述这个角色信息和依赖关系

```yaml
dependencies:
  - role: common
  - role: k8s-master
```

### 角色器任务文件 `common/tasks/main.yml`

```yaml
- name: Disable Swap
  shell: |
    swapoff -a
    sed -i '/swap/d' /etc/fstab

- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Load kernel modules
  shell: |
    modprobe overlay
    modprobe br_netfilter

- name: Set sysctl for Kubernetes networking
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-ip6tables = 1
  notify: Reload sysctl

- name: Install containerd (or Docker)
  apt:
    name:
      - containerd
    state: present
    update_cache: yes
```

### 角色任务文件 `k8s-master/tasks/main.yml`

```yaml
- name: Copy kubeadm config
  copy:
    src: ../../kubeadm-config.yaml
    dest: /root/kubeadm-config.yaml

- name: Init Kubernetes Master
  shell: |
    kubeadm init --config /root/kubeadm-config.yaml --upload-certs
  args:
    creates: /etc/kubernetes/admin.conf
  register: kubeadm_init_result
  
- name: Set KUBECONFIG for root
  shell: |
    mkdir -p $HOME/.kube
    cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    chown $(id -u):$(id -g) $HOME/.kube/config

- name: Deploy Calico network plugin
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml

- name: Deploy local-path-provisioner
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

- name: Get join token
  shell: kubeadm token create --print-join-command
  register: join_command

- name: Set fact for join command
  set_fact:
    kube_join_command: "{{ join_command.stdout }}"
```

### 角色任务文件 `k8s-node/tasks/main.yml`

```yaml
- name: Join worker node to cluster
  shell: "{{ hostvars['master'].kube_join_command }} --root-dir /iflytek/kubelet"
  when: "'node' in inventory_hostname"
```

## 执行

```shell
ansible-playbook playbook.yml
ansible-playbook playbook.yml -i inventory.ini
ansible-playbook playbook.yml -i inventory.ini --tags=k8s-master
```
